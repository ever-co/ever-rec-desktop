import {
  Directive,
  ElementRef,
  HostBinding,
  HostListener,
  Input,
} from '@angular/core';

@Directive({
  selector: 'img[libIconFallback]',
  standalone: true,
})
export class IconFallbackDirective {
  @Input() libIconFallback!: string;

  @HostBinding('class.loading') isLoading = true;
  @HostBinding('class.error') hasError = false;

  private fallbackAttempts = 0;
  private readonly maxAttempts = 3;

  @HostListener('error')
  onError() {
    this.handleImageError();
  }

  @HostListener('load')
  onLoad() {
    this.isLoading = false;
    this.hasError = false;
  }

  constructor(private el: ElementRef<HTMLImageElement>) {}

  private handleImageError() {
    const element = this.el.nativeElement;

    this.isLoading = false;
    this.hasError = true;

    if (this.fallbackAttempts < this.maxAttempts) {
      this.fallbackAttempts++;

      // Try loading the fallback image
      element.src = this.libIconFallback;
    } else {
      // If all attempts fail, set to a data URI of a minimal placeholder
      element.src =
        'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMiA1MTI7IiB4bWw6c3BhY2U9InByZXNlcnZlIiB3aWR0aD0iNTEycHgiIGhlaWdodD0iNTEycHgiPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik01MDguODc1LDE4LjIwOGM0LjE2Ny00LjE2Nyw0LjE2Ny0xMC45MTcsMC0xNS4wODNjLTQuMTY3LTQuMTY3LTEwLjkxNy00LjE2Ny0xNS4wODMsMGwtMzUuNTQ0LDM1LjU0NCAgICBDNDMwLjc1MywxNC42NjUsMzk0LjkwOCwwLDM1NS42MjUsMGgtMTk5LjI1QzExNy4wOTIsMCw4MS4yNDcsMTQuNjY1LDUzLjc1MywzOC42NjlMMTguMjA4LDMuMTI1ICAgIGMtNC4xNjctNC4xNjctMTAuOTE3LTQuMTY3LTE1LjA4Mywwcy00LjE2NywxMC45MTcsMCwxNS4wODNsMzUuNTQ0LDM1LjU0NEMxNC42NjUsODEuMjQ3LDAsMTE3LjA5MiwwLDE1Ni4zNzV2MTk5LjI1ICAgIGMwLDM5LjI4MywxNC42NjUsNzUuMTI4LDM4LjY2OSwxMDIuNjIyTDMuMTI1LDQ5My43OTJjLTQuMTY3LDQuMTY3LTQuMTY3LDEwLjkxNywwLDE1LjA4M0M1LjIwOCw1MTAuOTU4LDcuOTM4LDUxMiwxMC42NjcsNTEyICAgIGMyLjcyOSwwLDUuNDU4LTEuMDQyLDcuNTQyLTMuMTI1bDM1LjU0NC0zNS41NDRDODEuMjQ3LDQ5Ny4zMzUsMTE3LjA5Miw1MTIsMTU2LjM3NSw1MTJoMTk5LjI1ICAgIGMzOS4yODMsMCw3NS4xMjgtMTQuNjY1LDEwMi42MjItMzguNjY5bDM1LjU0NCwzNS41NDRjMi4wODMsMi4wODMsNC44MTMsMy4xMjUsNy41NDIsMy4xMjVjMi43MjksMCw1LjQ1OC0xLjA0Miw3LjU0Mi0zLjEyNSAgICBjNC4xNjctNC4xNjcsNC4xNjctMTAuOTE3LDAtMTUuMDgzbC0zNS41NDQtMzUuNTQ0QzQ5Ny4zMzUsNDMwLjc1Myw1MTIsMzk0LjkwOCw1MTIsMzU1LjYyNXYtMTk5LjI1ICAgIGMwLTM5LjI4My0xNC42NjUtNzUuMTI4LTM4LjY2OS0xMDIuNjIyTDUwOC44NzUsMTguMjA4eiBNNDIuNjY3LDQyOC4xNzdjLTEzLjQzNi0yMC45ODMtMjEuMzMzLTQ1Ljg0MS0yMS4zMzMtNzIuNTUydi0xOTkuMjUgICAgYzAtMjYuNzExLDcuODk3LTUxLjU2OSwyMS4zMzMtNzIuNTUyVjQyOC4xNzd6IE0yMDMuOTQ5LDE4OC44NjZjMTQuNDUxLTExLjIzMywzMi4zNjgtMTguMTk5LDUyLjA1MS0xOC4xOTkgICAgczM3LjYsNi45NjYsNTIuMDUxLDE4LjE5OUwyNTYsMjQwLjkxN0wyMDMuOTQ5LDE4OC44NjZ6IE0zMDguMDUxLDMyMy4xMzRDMjkzLjYsMzM0LjM2NywyNzUuNjgyLDM0MS4zMzMsMjU2LDM0MS4zMzMgICAgcy0zNy42LTYuOTY2LTUyLjA1MS0xOC4xOTlMMjU2LDI3MS4wODNMMzA4LjA1MSwzMjMuMTM0eiBNMjQwLjkxNywyNTZsLTUyLjA0OSw1Mi4wNDljLTExLjIzNC0xNC40NTItMTguMjAxLTMyLjM3LTE4LjIwMS01Mi4wNDkgICAgczYuOTY2LTM3LjU5OCwxOC4yMDEtNTIuMDQ5TDI0MC45MTcsMjU2eiBNMTg4Ljg3NSwzMzguMjA4YzE4LjM5MiwxNS4wNDgsNDEuNTY1LDI0LjQ1OCw2Ny4xMjUsMjQuNDU4czQ4LjczMy05LjQxLDY3LjEyNS0yNC40NTggICAgbDYwLjY3Niw2MC42NzZDMzQ5LjgxNSw0MjkuMzE1LDMwNS4xMDQsNDQ4LDI1Niw0NDhzLTkzLjgxNS0xOC42ODUtMTI3LjgwMS00OS4xMTZMMTg4Ljg3NSwzMzguMjA4eiBNMjcxLjA4MywyNTZsNTIuMDQ5LTUyLjA0OSAgICBjMTEuMjM0LDE0LjQ1MiwxOC4yMDEsMzIuMzcsMTguMjAxLDUyLjA0OXMtNi45NjYsMzcuNTk4LTE4LjIwMSw1Mi4wNDlMMjcxLjA4MywyNTZ6IE0zMjMuMTI1LDE3My43OTIgICAgYy0xOC4zOTItMTUuMDQ4LTQxLjU2NS0yNC40NTgtNjcuMTI1LTI0LjQ1OHMtNDguNzMzLDkuNDEtNjcuMTI1LDI0LjQ1OGwtNjAuNjc2LTYwLjY3NkMxNjIuMTg1LDgyLjY4NSwyMDYuODk2LDY0LDI1Niw2NCAgICBzOTMuODE1LDE4LjY4NSwxMjcuODAxLDQ5LjExNkwzMjMuMTI1LDE3My43OTJ6IE0zNDguMzc0LDY0aDg0LjU0M2wtMzQuMDM5LDM0LjAzOUMzODMuODIsODQuNDA2LDM2Ni44NTQsNzIuOTMsMzQ4LjM3NCw2NHogICAgIE0xNTYuMzc1LDIxLjMzM2gxOTkuMjVjMjYuNzExLDAsNTEuNTY5LDcuODk3LDcyLjU1MiwyMS4zMzNIODMuODIzQzEwNC44MDYsMjkuMjMsMTI5LjY2NCwyMS4zMzMsMTU2LjM3NSwyMS4zMzN6IE0xNjMuNjI4LDY0ICAgIGMtMTguNDgsOC45My0zNS40NDgsMjAuNDA2LTUwLjUwNSwzNC4wMzlMNzkuMDgzLDY0SDE2My42Mjh6IE02NCw3OS4wODNsMzQuMDQsMzQuMDRDODQuNDA4LDEyOC4xODEsNzIuOTMsMTQ1LjE0Niw2NCwxNjMuNjI4ICAgIFY3OS4wODN6IE0xMTMuMTE2LDEyOC4xOTlsNjAuNjc2LDYwLjY3NmMtMTUuMDQ4LDE4LjM5Mi0yNC40NTgsNDEuNTY1LTI0LjQ1OCw2Ny4xMjVzOS40MSw0OC43MzMsMjQuNDU4LDY3LjEyNWwtNjAuNjc2LDYwLjY3NiAgICBDODIuNjg1LDM0OS44MTQsNjQsMzA1LjEwMiw2NCwyNTZTODIuNjg1LDE2Mi4xODYsMTEzLjExNiwxMjguMTk5eiBNNjQsMzQ4LjM3MmM4LjkzLDE4LjQ4MiwyMC40MDgsMzUuNDQ3LDM0LjA0LDUwLjUwNCAgICBMNjQsNDMyLjkxN1YzNDguMzcyeiBNMTEzLjEyMiw0MTMuOTYxYzE1LjA1NywxMy42MzMsMzIuMDI1LDI1LjEwOSw1MC41MDUsMzQuMDM5SDc5LjA4M0wxMTMuMTIyLDQxMy45NjF6IE0zNTUuNjI1LDQ5MC42NjcgICAgaC0xOTkuMjVjLTI2LjcxMSwwLTUxLjU2OS03Ljg5Ny03Mi41NTItMjEuMzMzaDM0NC4zNTRDNDA3LjE5NCw0ODIuNzcsMzgyLjMzNiw0OTAuNjY3LDM1NS42MjUsNDkwLjY2N3ogTTM0OC4zNzQsNDQ4ICAgIGMxOC40OC04LjkzLDM1LjQ0Ny0yMC40MDYsNTAuNTA0LTM0LjAzOUw0MzIuOTE3LDQ0OEgzNDguMzc0eiBNNDQ4LDQzMi45MTdsLTM0LjA0LTM0LjA0ICAgIGMxMy42MzMtMTUuMDU2LDI1LjExMS0zMi4wMjIsMzQuMDQtNTAuNTAzVjQzMi45MTd6IE0zOTguODg0LDM4My44MDFsLTYwLjY3Ni02MC42NzZjMTUuMDQ4LTE4LjM5MiwyNC40NTgtNDEuNTY1LDI0LjQ1OC02Ny4xMjUgICAgcy05LjQxLTQ4LjczMy0yNC40NTgtNjcuMTI1bDYwLjY3Ni02MC42NzZDNDI5LjMxNSwxNjIuMTg2LDQ0OCwyMDYuODk4LDQ0OCwyNTZTNDI5LjMxNSwzNDkuODE0LDM5OC44ODQsMzgzLjgwMXogTTQ0OCwxNjMuNjI2ICAgIGMtOC45My0xOC40OC0yMC40MDgtMzUuNDQ3LTM0LjA0LTUwLjUwM0w0NDgsNzkuMDgzVjE2My42MjZ6IE00OTAuNjY3LDE1Ni4zNzV2MTk5LjI1YzAsMjYuNzExLTcuODk3LDUxLjU2OS0yMS4zMzMsNzIuNTUyICAgIFY4My44MjNDNDgyLjc3LDEwNC44MDYsNDkwLjY2NywxMjkuNjY0LDQ5MC42NjcsMTU2LjM3NXoiIGZpbGw9IiM3NTc1NzUiLz4KCTwvZz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K';
    }
  }
}
