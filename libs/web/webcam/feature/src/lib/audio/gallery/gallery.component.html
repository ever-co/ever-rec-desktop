@let audios = audios$ | async;

<!-- Is Available -->
@let currentAudio = currentAudio$ | async;

<!-- playing -->
@let isPlaying = isPlaying$ | async;

<!-- progress -->
@let progress = progressPercentage$ | async;

<!-- current time -->
@let currentTime = currentTimeFormatted$ | async;

<!-- duration -->
@let duration = durationFormatted$ | async;

<!-- Is Mobile View -->
@let isMobileView = layoutService.isMobileView();

<!-- Available -->

@if (isAvailable$ | async) {
<div
  class="flex"
  [ngClass]="{
    'flex-col-reverse sm:flex-row': isMobileView,
    'gap-2': !isMobileView,
    'gap-4 sm:gap-2': isMobileView
  }"
>
  <div
    libInfiniteScroll
    (scrolled)="moreAudios()"
    class="grid grid-cols-1 static gap-4 overflow-auto max-h-custom main"
    [ngClass]="{
      'pr-4': !isMobileView,
      'sm:pr-4': isMobileView,
      'sm:grid-cols-2': !isMobileView && !currentAudio
    }"
  >
    @for (audio of audios; track audio.id) {
    <!-- Check if the audio is selected -->
    @let isSelected = audio.id === currentAudio?.id;
    <!-- Get duration -->
    @let audioDuration = audio?.metadata?.duration| humanize : 's' : 'mm:ss' : {
    trim: false };
    <!-- Is checked -->
    @let checked = isChecked(audio) | async;
    <!-- Check if the audio is playing -->
    <div
      [ngClass]="{
        'pt-12': checked,
        'bg-gray-200': checked
      }"
      class="relative backdrop-blur-md rounded-lg hover:bg-gray-200 hover:pt-12 group"
    >
      <lib-audio-inline
        class="card"
        [audio]="audio"
        [isPlaying]="isPlaying && isSelected"
        [progress]="isSelected ? progress : 0"
        [currentTime]="isSelected ? currentTime : '00:00'"
        [duration]="isSelected ? duration : audioDuration"
        (playPause)="synchronize(audio)"
      ></lib-audio-inline>
      <div
        class="flex w-full text-gray-900 z-[-1] absolute items-center top-0 pr-4 pl-4 group-hover:z-10 justify-between"
        [ngClass]="{
          'z-10': checked
        }"
      >
        <mat-checkbox
          [checked]="checked"
          (change)="selectAudio($event.checked, audio)"
          [color]="'primary'"
          class="text-white transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-white rounded group-hover:text-indigo-600"
        >
        </mat-checkbox>
        <button [libPopover]="group" mat-icon-button>
          <mat-icon>more_horiz</mat-icon>
        </button>
      </div>
    </div>

    <ng-template #group>
      <div class="flex bg-white rounded-df shadow-lg flex-col p-2">
        <lib-action-button
          [button]="infoButton"
          [libPopover]="metadata"
          [popoverContext]="{ audio }"
        ></lib-action-button>
        <lib-action-button
          [button]="deleteButton"
          [data]="audio"
        ></lib-action-button>
      </div>
    </ng-template>
    }
  </div>

  @if(currentAudio) {
  <div
    class="flex gap-6"
    [ngClass]="{
    'flex-col': isMobileView,
     }"
  >
    <div class="relative">
      <lib-audio-player-container
        [audio]="currentAudio"
        [mode]="mode"
        class="card"
      ></lib-audio-player-container>

      <div
        class="flex block sm:hidden w-full absolute top-3 right-3 justify-end"
      >
        <button [libPopover]="metadata" mat-icon-button>
          <mat-icon>more_vert</mat-icon>
        </button>
      </div>
    </div>

    <div class="hidden sm:block">
      <ng-container
        *ngTemplateOutlet="metadata; context: { showDetails: !isMobileView }"
      ></ng-container>
    </div>
  </div>
  }
</div>

@if((size$ | async)) {
<div class="absolute inset-x-0 action-button-group">
  <lib-gallery-buttons-action
    [buttons]="actionButtons"
    [size]="size$ | async"
    [data]="selectedAudios$ | async"
  ></lib-gallery-buttons-action>
</div>
} } @else {
<div class="flex h-full items-center p-4 justify-center">
  <lib-no-data message="No audios available" class="text-center text-gray-500">
  </lib-no-data>
</div>
}

<ng-template #metadata let-audio="audio" let-showDetails="showDetails">
  @if(currentAudio || audio) {
  <div
    [ngClass]="{
      'max-w-96': isMobileView,
      'max-w-80': !isMobileView,
     }"
  >
    <lib-audio-metadata
      [audio]="audio || currentAudio"
      [showDetailedInfo]="showDetails || true"
    ></lib-audio-metadata>
  </div>

  }
</ng-template>
