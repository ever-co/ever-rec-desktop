@let statistics = (statistics$ | async) || [];

<!-- structure -->

@if (statistics.length) {
  <div class="w-full">
    <h4 class="text-xl md:text-xl font-bold title mb-6">Applications</h4>
    <lib-screenshot-statistics-chart
      class="chart"
    ></lib-screenshot-statistics-chart>
    <div class="grid grid-cols-1 gap-4 mb-4">
      <lib-waterfall-chart
        class="chart"
        [data]="statistics"
      ></lib-waterfall-chart>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <lib-effect-size-matrix [data]="statistics"></lib-effect-size-matrix>
        <lib-power-analysis-graph
          [data]="statistics"
        ></lib-power-analysis-graph>
      </div>
    </div>
    <!-- Responsive Grid -->
    <div
      libInfiniteScroll
      (scrolled)="moreStats()"
      class="grid grid-cols-1 main sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 max-h-screen md:max-h-96 overflow-auto"
    >
      @for (statistic of statistics; track statistic.name) {
        <mat-card
          appearance="outlined"
          class="transform transition-all mt-3 duration-300 ease-in-out bg-white hover:shadow-md hover:-translate-y-0.5 break-words cursor-pointer border border-gray-100 rounded-xl"
          (click)="onSearch(statistic)"
          [attr.aria-label]="'Statistics for ' + statistic.name"
        >
          <mat-card-content class="p-4 sm:p-5">
            <!-- Header Section -->
            <div class="flex items-start justify-between gap-3 mb-4">
              <div class="flex items-start min-w-0 gap-3 flex-1">
                <img
                  [src]="statistic.icon"
                  [alt]="statistic.name + ' icon'"
                  libIconFallback
                  class="w-9 h-9 rounded-lg bg-gray-50 p-1 object-contain border border-gray-200"
                />
                <div class="min-w-0">
                  <div
                    class="text-base sm:text-lg font-semibold text-gray-700 truncate"
                  >
                    {{ statistic.name }}
                  </div>
                  <p class="text-xs block sm:hidden text-gray-500 truncate">
                    {{ statistic.count | numberSuffix }} of
                    {{ statistic.total | numberSuffix }} screenshots
                  </p>
                </div>
              </div>

              <!-- Trend Indicator -->
              @if (statistic.trend !== undefined) {
                <div class="flex flex-col items-end">
                  <div
                    class="flex items-center gap-1"
                    [ngClass]="{
                      'text-green-600': statistic.trend > 0,
                      'text-gray-600': statistic.trend === 0,
                      'text-rose-600': statistic.trend < 0,
                    }"
                  >
                    <mat-icon class="text-base">
                      {{
                        statistic.trend > 0
                          ? 'trending_up'
                          : statistic.trend === 0
                            ? 'trending_flat'
                            : 'trending_down'
                      }}
                    </mat-icon>
                    <span class="text-sm font-medium tabular-nums">
                      {{ statistic.trend | percent: '1.0-1' }}
                    </span>
                  </div>
                  @if (statistic.confidence) {
                    <div class="text-xs block sm:hidden text-gray-500 mt-0.5">
                      Confidence:
                      {{ statistic.confidence | percent: '1.0-0' }}
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Progress Section -->
            <div class="space-y-3">
              <div
                class="hidden sm:flex flex-col sm:flex-row sm:justify-between sm:items-baseline gap-2"
              >
                <div class="flex items-baseline gap-2">
                  <span class="text-xl sm:text-2xl font-bold text-gray-800">
                    {{ statistic.count | numberSuffix }}
                  </span>
                  <span class="text-sm text-gray-500">
                    of {{ statistic.total | numberSuffix }} screenshots
                  </span>
                </div>
                <span
                  class="text-sm hidden sm:inline font-medium text-gray-600"
                >
                  {{ statistic.count / statistic.total | percent: '1.0-1' }}
                </span>
              </div>
              <!-- Progress Bar with Tooltip -->
              <div class="relative w-full group">
                <mat-progress-bar
                  class="rounded-full"
                  [color]="getColor((statistic.count * 100) / statistic.total)"
                  mode="determinate"
                  [value]="calculateProgress(statistic.count, statistic.total)"
                  aria-label="Usage percentage"
                >
                </mat-progress-bar>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span
                    class="text-xs font-medium text-white bg-black bg-opacity-75 px-1.5 py-0.5 rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none"
                  >
                    {{ statistic.count / statistic.total | percent: '1.1-1' }}
                    usage
                  </span>
                </div>
              </div>

              <!-- Stats Summary -->
              <div class="grid grid-cols-3 gap-2 sm:hidden text-xs">
                <div class="bg-gray-50 rounded p-2 text-center">
                  <div class="text-gray-500 font-medium">Count</div>
                  <div class="font-bold text-gray-800">
                    {{ statistic.count | numberSuffix }}
                  </div>
                </div>

                <div class="bg-gray-50 rounded p-2 text-center">
                  <div class="text-gray-500 font-medium">Usage</div>
                  <div class="font-bold text-gray-800">
                    {{ statistic.count / statistic.total | percent: '1.1-1' }}
                  </div>
                </div>

                @if (statistic.effectSize !== undefined) {
                  <div
                    class="bg-gray-50 rounded p-2 text-center"
                    [ngClass]="{
                      'text-green-600': statistic.effectSize > 0.5,
                      'text-amber-600':
                        statistic.effectSize <= 0.5 &&
                        statistic.effectSize > 0.2,
                      'text-gray-600': statistic.effectSize <= 0.2,
                    }"
                  >
                    <div class="text-gray-500 font-medium">Impact</div>
                    <div class="font-bold">
                      {{ statistic.effectSize | number: '1.2-2' }}
                    </div>
                  </div>
                }
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      }
    </div>
  </div>
} @else {
  <div class="flex no-data h-full items-center min-h-96 p-4 justify-center">
    <lib-no-data
      message="No screenshots statistics available"
      class="text-center text-gray-500"
    >
    </lib-no-data>
  </div>
}
